<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İbni Sina MTAL - 55 Kişilik Otobüs Rezervasyon</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- FİREBASE YAPILANDIRMASI (Bilgileriniz Korundu) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDtEwuanPce0yE10JvP567QnesgGD4dPfw",
            authDomain: "https://dkunix-default-rtdb.firebaseio.com",
            projectId: "dkunix",
            storageBucket: "dkunix.firebasestorage.app",
            messagingSenderId: "841856763234",
            appId: "1:841856763234:web:845861d735c7f5ec99183b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let busData = {};
        let currentBusId = 'bus1';
        let selectedSeatId = null;

        window.onload = async () => {
            try {
                await signInAnonymously(auth);
                const docRef = doc(db, "otobus_verileri", "rezervasyonlar_55"); // Yeni şema için farklı doküman
                
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        busData = docSnap.data();
                    } else {
                        // 55 Kişilik Varsayılan Yapı
                        busData = {
                            'bus1': { name: '1. Otobüs (Okul Önü)', seats: generate55Seats() },
                            'bus2': { name: '2. Otobüs (Kale Center)', seats: generate55Seats() }
                        };
                        setDoc(docRef, busData);
                    }
                    renderApp();
                });
            } catch (err) {
                console.error("Hata:", err);
            }
        };

        // 55 Kişilik Koltuk Üretme Fonksiyonu
        function generate55Seats() {
            let seats = {};
            // 1-13 arası sıralar (Orta kapı hariç)
            for(let i=1; i<=13; i++) {
                // Orta kapı 7. sıradan sonra sağ tarafta
                if(i === 8) {
                    seats[`${i}A`] = null; seats[`${i}B`] = null;
                    // C ve D koltuğu yok (Orta Kapı Boşluğu)
                } else {
                    ['A','B','C','D'].forEach(l => seats[`${i}${l}`] = null);
                }
            }
            // En arka 14. sıra (5 kişi)
            ['14A','14B','14C','14D','14E'].forEach(l => seats[l] = null);
            return seats;
        }

        function renderApp() {
            const container = document.getElementById('seat-grid');
            if (!container || !busData[currentBusId]) return;

            container.innerHTML = '';
            const seats = busData[currentBusId].seats;
            document.getElementById('bus-title').textContent = busData[currentBusId].name;

            // Şoför Alanı
            const driverArea = document.createElement('div');
            driverArea.className = "w-full bg-slate-200 border-2 border-slate-400 p-4 mb-6 rounded-xl text-center font-black text-slate-500 tracking-[0.5em]";
            driverArea.innerHTML = "ŞÖFÖR VE REHBER ALANI";
            container.appendChild(driverArea);

            const gridDiv = document.createElement('div');
            gridDiv.className = "w-full space-y-2";

            // Sıraları Çiz (1-13)
            for(let i=1; i<=13; i++) {
                const row = document.createElement('div');
                row.className = "flex justify-center items-center gap-2";

                // Sol taraf (A ve B)
                row.appendChild(createSeatElement(`${i}A`, seats[`${i}A`]));
                row.appendChild(createSeatElement(`${i}B`, seats[`${i}B`]));

                // Koridor
                const aisle = document.createElement('div');
                aisle.className = "w-8 text-[10px] text-slate-300 font-bold text-center";
                aisle.textContent = i;
                row.appendChild(aisle);

                // Sağ taraf (C ve D)
                if(i === 8) {
                    // Orta kapı boşluğu
                    const door = document.createElement('div');
                    door.className = "w-[104px] h-12 flex items-center justify-center text-[10px] font-bold text-slate-400 bg-slate-50 border border-dashed rounded-lg";
                    door.textContent = "ORTA KAPI";
                    row.appendChild(door);
                } else {
                    row.appendChild(createSeatElement(`${i}C`, seats[`${i}C`]));
                    row.appendChild(createSeatElement(`${i}D`, seats[`${i}D`]));
                }
                gridDiv.appendChild(row);
            }

            // En Arka Sıra (14A-E)
            const backRow = document.createElement('div');
            backRow.className = "flex justify-center items-center gap-1 mt-4 pt-4 border-t-2 border-dashed border-slate-200";
            ['14A','14B','14C','14D','14E'].forEach(id => {
                backRow.appendChild(createSeatElement(id, seats[id]));
            });
            gridDiv.appendChild(backRow);

            container.appendChild(gridDiv);
        }

        function createSeatElement(id, name) {
            const seat = document.createElement('div');
            const isTaken = !!name;
            seat.className = `w-12 h-12 rounded-lg border-2 flex items-center justify-center cursor-pointer text-[9px] font-bold transition-all
                ${isTaken ? 'bg-red-100 border-red-500 text-red-800' : 'bg-emerald-50 border-emerald-500 text-emerald-700'}
                ${selectedSeatId === id ? 'ring-4 ring-blue-500 scale-110 shadow-lg z-10' : 'hover:bg-white'}`;
            
            seat.innerHTML = `<div class="text-center"><span class="block opacity-40 text-[7px]">${id}</span>${name ? name.substring(0,8) : 'BOŞ'}</div>`;
            seat.onclick = () => {
                selectedSeatId = id;
                document.getElementById('panel').classList.remove('hidden');
                document.getElementById('seat-info').textContent = `Koltuk: ${id}`;
                document.getElementById('passenger-name').value = name || '';
                renderApp();
            };
            return seat;
        }

        window.saveData = async () => {
            const name = document.getElementById('passenger-name').value.trim();
            const docRef = doc(db, "otobus_verileri", "rezervasyonlar_55");
            const updatePath = `${currentBusId}.seats.${selectedSeatId}`;
            await updateDoc(docRef, { [updatePath]: name || null });
            document.getElementById('panel').classList.add('hidden');
            selectedSeatId = null;
        };

        window.changeBus = (id) => {
            currentBusId = id;
            selectedSeatId = null;
            document.getElementById('panel').classList.add('hidden');
            document.querySelectorAll('.bus-tab').forEach(btn => btn.classList.replace('bg-blue-600', 'bg-slate-400'));
            document.getElementById('tab-' + id).classList.replace('bg-slate-400', 'bg-blue-600');
            renderApp();
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-6 flex justify-center items-start">

    <div class="w-full max-w-xl bg-white rounded-[2.5rem] shadow-2xl p-6 md:p-8 border border-slate-200">
        <header class="text-center mb-6">
            <h1 class="text-2xl font-black text-slate-800 tracking-tighter uppercase">İbni Sina MTAL</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">55 Kişilik Canlı Rezervasyon</p>
        </header>
        
        <div class="flex gap-2 mb-6">
            <button id="tab-bus1" onclick="changeBus('bus1')" class="bus-tab flex-1 py-3 bg-blue-600 text-white rounded-2xl font-bold transition shadow-md">1. OTOBÜS</button>
            <button id="tab-bus2" onclick="changeBus('bus2')" class="bus-tab flex-1 py-3 bg-slate-400 text-white rounded-2xl font-bold transition">2. OTOBÜS</button>
        </div>

        <h2 id="bus-title" class="text-center font-black text-blue-500 uppercase text-[10px] mb-4 tracking-[0.2em]">Yükleniyor...</h2>

        <!-- Koltuk Planı Izgarası (Dikey Otobüs Görünümü) -->
        <div id="seat-grid" class="flex flex-col items-center bg-slate-50 p-4 rounded-[2rem] border border-slate-200 shadow-inner overflow-y-auto max-h-[70vh]">
            <!-- JavaScript ile doldurulur -->
        </div>

        <!-- Yüzen İşlem Paneli -->
        <div id="panel" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-md p-6 border-2 border-blue-500 rounded-[2rem] bg-white shadow-2xl z-50 animate-in fade-in slide-in-from-bottom-8 duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 id="seat-info" class="font-black text-blue-600 uppercase">Koltuk Seçimi</h3>
                <button onclick="document.getElementById('panel').classList.add('hidden')" class="bg-slate-100 p-2 rounded-full text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input id="passenger-name" type="text" 
                   class="w-full p-4 bg-slate-50 border-none rounded-2xl mb-4 text-sm font-bold shadow-inner outline-none focus:ring-4 ring-blue-100" 
                   placeholder="Yolcu Adı Soyadı">
            <button onclick="saveData()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black transition-all shadow-lg active:scale-95">
                LİSTEYİ GÜNCELLE
            </button>
        </div>
    </div>

</body>
</html>